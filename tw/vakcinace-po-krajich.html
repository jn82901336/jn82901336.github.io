<!doctype html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />
<meta name="author" content="@jn82901336">
<script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.4/dist/Chart.min.js" integrity="sha256-t9UJPrESBeG2ojKTIcFLPGF7nHi2vEc7f5A2KpH/UBU=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/tablesorter@2.31.3/dist/js/jquery.tablesorter.combined.min.js" integrity="sha256-ounC3wWwZ9iBUyF8x1+X+REppGjK+p6/+w+ky1MGoMM=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/tablesorter@2.31.3/dist/js/widgets/widget-staticRow.min.js" integrity="sha256-R6i4bUXJfhXW8M9vaQ3ouBM/UEZ7A/Nn0FRKKOpyOO8=" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tablesorter@2.31.3/dist/css/theme.default.min.css" integrity="sha256-5sgExNTnkN8NcApKIU73/aqgZmqq/zJp9+9zXf9aSEw=" crossorigin="anonymous" >
</head>
<style>

#t td {
 text-align: right;
}
thead th {
  text-align: center;
}

.celkem th,  .celkem td{
 background-color: grey !important;
 color: white;
}

</style>
<body>
<h1>Přehled vakcinace po krajích</h1>
<table id='t'>
</table>
údaje v dávkách<br>
vyočkováno=evidovaná očkování (1)<br>
<!-- vyskladněno=vyskladněno z krajských skladů k očkování(2)<br> -->
dodáno=+dodávky z centralního do krajských skladů+-mezikrajové převody (2)<br>
data z <a href='https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19'>https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19</a><br>
1: COVID-19: Přehled vykázaných očkování podle krajů ČR <span id='dockovani'>..nahrávám</span></br>
<!-- 2: COVID-19: Přehled spotřeby podle očkovacích míst ČR <span id='dspotreba'>..nahrávám</span></br> -->
2: COVID-19: Přehled distribuce očkovacích látek v ČR <span id='dprijem'>..nahrávám</span><br>
<!-- canvas id="ctx" width="400" height="400"></canvas-->
<script>
</script>
</body>
<script>
window.onload = function() {
var url={};
url['prijem']='https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/ockovani-distribuce.min.json';
url['spotreba']='https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/ockovani-spotreba.min.json';
url['ockovani']='https://onemocneni-aktualne.mzcr.cz/api/v2/covid-19/ockovani.min.json';
var prijem = {};
var spotreba = {};
var ockovani ={};
var timelineP ={};
var timelineS ={};
var vakciny = {};
var celkemO={};
var celkemS={};
var celkemP={};
// var thdescr =['dodáno','vyočkováno','%','vyskladněno','%'];
var thdescr =['dodáno','vyočkováno','%'];

 function populateTable(){

  var t=$('#t');
  var thead=$('<thead/>');
  var tbody=$('<tbody/>');
  var tr = $('<tr id=\'th1\'/>');
  var tr2 = $('<tr/>');
  tr.append("<td data-sorter='false'/>");
  tr2.append("<td data-sorter='false'/>");
  $.each(Object.keys(vakciny), function (k, vakcina){
   tr.append("<th colspan='3' data-sorter='false'>" + vakcina.replace("COVID-19 Vaccine",'') + "</th>");
   $.each(thdescr,function (l,d){
    tr2.append("<th data-filter='false'>"+d+"</th>");
    celkemS[vakcina]=celkemO[vakcina]=celkemP[vakcina]=0;
   });
  });
  thead.append(tr);
  thead.append(tr2);
  t.append(thead);

  $.each(Object.keys(prijem), function (key, kraj){
   var tr = $('<tr/>');
   tr.append("<th>" + kraj.replace(/kraj/i,'') + "</th>");
   $.each(Object.keys(vakciny), function (k,vakcina){
//    var s=(spotreba[kraj][vakcina]) ? spotreba[kraj][vakcina] : 0;
    var o=(ockovani[kraj][vakcina]) ? ockovani[kraj][vakcina] : 0;
    var p=(prijem[kraj][vakcina]) ? prijem[kraj][vakcina] : 0;
    var opct = (p > 0 ) ? Math.round(o*100/p) : '-';
//    var spct = (p > 0 ) ? Math.round(s*100/p) : '-';
    tr.append("<td>" + p + "</td>");
    tr.append("<td>" + o + "</td>");
    tr.append("<td>" + opct + "%</td>");
//    tr.append("<td>" + s + "</td>");
//    tr.append("<td>" + spct + "%</td>");
//    celkemS[vakcina]+=s;
    celkemP[vakcina]+=p;
    celkemO[vakcina]+=o;
   });
   tbody.append(tr);
  });

   var tr = $("<tr class='celkem' />");
   tr.append("<th>Celkem</th>");
   $.each(Object.keys(vakciny), function (k,vakcina){
//    var s=celkemS[vakcina];
    var p=celkemP[vakcina];
    var o=celkemO[vakcina];
    var opct = (p > 0 ) ? Math.round(o*100/p) : '-';
//    var spct = (p > 0 ) ? Math.round(s*100/p) : '-';
    tr.append("<td>" + p + "</td>");
    tr.append("<td>" + o + "</td>");
    tr.append("<td>" + opct + "%</td>");
//    tr.append("<td>" + s + "</td>");
//    tr.append("<td>" + spct + "%</td>");
   });
   tbody.append(tr);
   

   t.append(tbody);
   
  $("#t").tablesorter({
  widgets: ["filter", "stickyHeaders","zebra","staticRow"],
   widgetOptions: {
        // Note it expects a CSS selector, not a raw class name
     staticRow_class: ".celkem"
    }
  
   }); 

 } //pupulateTable
 
 function addSpotreba(data){

 $.each( data, function(id,row ) {
   if (Array.isArray(row)) {
      $.each(row, function (key, val){
       if (val['pouzite_davky'] || val['znehodnocene_davky']){
        var ampulky=val['pouzite_davky']+val['znehodnocene_davky'];
        if (! spotreba[val['kraj_nazev']]) { spotreba[val['kraj_nazev']] = []}
           spotreba[val['kraj_nazev']][val['ockovaci_latka']] = 
            (! spotreba[val['kraj_nazev']][val['ockovaci_latka']]) ? ampulky
           : spotreba[val['kraj_nazev']][val['ockovaci_latka']]+ampulky;
   
       }  
  
      });
   }else if(id=='modified'){
    $('#dspotreba').html('('+row+')');    
   }//isArray
  });
  populateTable();
 }

 function addPrijem(data){
     var a=b=0;
   
 $.each( data, function(id,row ) {

   if (Array.isArray(row)) {
      $.each(row, function (key, val){
       vakciny[val['ockovaci_latka']]=1;
       if (val['pocet_ampulek']){


       var kraj=val['kraj_nuts_kod'];       
       var ockovaci_latka=val['ockovaci_latka'];       
       var datum=val['datum'];       
       var pocet_ampulek=val['pocet_ampulek'];       
       var pocet_davek=val['pocet_davek'];
       var cilovy_kraj_kod=val['cilovy_kraj_kod'];
       
       if (! timelineP[datum] ){
          timelineP[datum]={};
          timelineS[datum]={};
       
       }

        if (typeof  prijem[val['kraj_nazev']] === 'undefined') { 
          prijem[val['kraj_nazev']] = {};
        }

        if (val['cilovy_kraj_nazev'] && ! prijem[val['cilovy_kraj_nazev']]) { prijem[val['cilovy_kraj_nazev']] = []}
         if(val['akce']=='Příjem'){
           prijem[val['kraj_nazev']][val['ockovaci_latka']] = 
            (! prijem[val['kraj_nazev']][val['ockovaci_latka']]) ?   pocet_davek
           : prijem[val['kraj_nazev']][val['ockovaci_latka']]+pocet_davek;

            if (! timelineP[datum]?.[kraj]?.[ockovaci_latka]){
             if (! timelineP[datum][kraj] ) timelineP[datum][kraj]=[];
             if (! timelineP[datum][kraj][ockovaci_latka]) timelineP[datum][kraj][ockovaci_latka]=[];
             timelineP[datum][kraj][ockovaci_latka]=pocet_davek;
            }else{   
             timelineP[datum][kraj][ockovaci_latka]+=pocet_davek;
            }
         }
        if (val['cilovy_kraj_kod'] != '' && val['kraj_nazev'] != val['cilovy_kraj_nazev']){
           if (! prijem[val['kraj_nazev']][val['ockovaci_latka']]){
             prijem[val['kraj_nazev']][val['ockovaci_latka']]=-pocet_davek;
           }else{
             prijem[val['kraj_nazev']][val['ockovaci_latka']]-=pocet_davek;
           }
           a-=pocet_davek;
           if(! timelineP[datum][cilovy_kraj_kod]) timelineP[datum][cilovy_kraj_kod]=[];
           if(! timelineP[datum][cilovy_kraj_kod][ockovaci_latka])timelineP[datum][cilovy_kraj_kod][ockovaci_latka]=[];
           timelineP[datum][cilovy_kraj_kod][ockovaci_latka]-=pocet_davek;
           //do kraje
           if (typeof prijem[val['cilovy_kraj_nazev']][val['ockovaci_latka']]  === 'undefined'){
               prijem[val['cilovy_kraj_nazev']][val['ockovaci_latka']]=pocet_davek;
               b+=pocet_davek;
           }else{
               prijem[val['cilovy_kraj_nazev']][val['ockovaci_latka']]+=pocet_davek;
               b+=pocet_davek; 
           }
/*           if (! timelineP[val['cilovy_kraj_kod']][val['ockovaci_latka']][val['datum']]){
               timelineP[val['cilovy_kraj_kod']][val['ockovaci_latka']][val['datum']]=val['pocet_ampulek'];
           }else{
               timelineP[val['cilovy_kraj_kod']][val['ockovaci_latka']][val['datum']]+=val['pocet_ampulek'];
           }
*/           
        } 
       }  
      });
   }else if(id=='modified'){
    $('#dprijem').html('('+row+')');    
} //isArray
   
  });
 $.getJSON(url['ockovani'], addOckovani);
 }//addPrijem

function addOckovani(data){
 $.each( data, function(id,row ) {
   if (Array.isArray(row)) {
      $.each(row, function (key, val){
//       var kraj=val['kraj_nuts_kod'];
       var kraj=val['kraj_nazev'];
       var vakcina=val['vakcina'];
       var datum=val['datum'];
       var celkem_davek=val['celkem_davek'];
       
       if(! ockovani?.[kraj]?.[vakcina] ){
        if(! ockovani[kraj])ockovani[kraj]={};
        ockovani[kraj][vakcina]=celkem_davek;
        
       }else{
        ockovani[kraj][vakcina]+=celkem_davek;
       }

      });//each
   }else if(id=='modified'){
    $('#dockovani').html('('+row+')');
   }//isArray  
 });
// $.getJSON(url['spotreba'], addSpotreba);
   populateTable();
 
}//addOckovani


$.getJSON(url['prijem'], addPrijem);



}

</script>
</html>